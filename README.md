# Trireme-csr

Trireme-CSR is an identity and root of trust service running as a controller on Kubernetes. It is used by Trireme-Kubernetes to bootstrap the root of trust, but could be used in other project as a standalone component.

It is composed of two distinct components:

* A client library: runtimes can import the trireme-csr client library and generate a `KeyPair` and associated `Certificate Signing Request`.
A `Custom Ressource Definition` is used in order to store the `CSR` on the Kubernetes API.
* A Trireme-CSR controller: as a controller on that `Custom Ressource Definition` is then responsible for validating and issuing the corresponding certificate.

The initial client receives the generated certificate as part of the `Custom Ressource Definition` status.

This scheme allows each node to receive a valid certificate generated by a central trusted `Certificate Authority`.

# Generating or providing a Valid CA

The Trireme-CSR requires a valid `Certificate Authority` in order to provide the root of trust.
This `Certificate Authority` can be an existing one in your organisation or it could be generated specifically for `Trireme-CSR`

The `Certificate Authority` is provided to the controler through a standard Kubernetes secret. It is expected to be found in a secret `trireme-cacert` by default.

This script can be used as an example on howto generate an example `Certificate Authority` and push it as a secret to `Kubernetes`:

```
wget https://raw.githubusercontent.com/aporeto-inc/trireme-kubernetes/master/deployment/gen_pki_ca.sh
./gen_pki_ca.sh
```

# Deploying the Trireme-CSR controller

The controller is deployed as a standard Kubernetes pod. It expect the CACert and CAKey to be mounted (By default it will be mounted from the existing secret).
It also requires the Certificate Custom Ressource definition to be already created.

All of this can be done by deploying the following files:

* Config Map used for all the configuration:
https://raw.githubusercontent.com/aporeto-inc/trireme-kubernetes/master/deployment/trireme/trireme-cm.yaml
* Certificate Custom Ressource Definition:
https://raw.githubusercontent.com/aporeto-inc/trireme-kubernetes/master/deployment/trireme/cert-crd.yaml
* ServiceAccount and roles used for access to the Certificates:
https://raw.githubusercontent.com/aporeto-inc/trireme-kubernetes/master/deployment/trireme/certgen-serviceaccount.yaml
* Trireme-CSR Controller as a ReplicaSet:
https://raw.githubusercontent.com/aporeto-inc/trireme-kubernetes/master/deployment/trireme/certgen-rs.yaml

# using the Trireme-CSR Client.



# Certificate Custom Resource Definition

# Using Kubernetes API as a gate keeper

# Prerequisite